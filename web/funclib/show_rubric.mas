<%args>
	$panel_id => undef
	$judge_id => undef
</%args>
<%init>

	my $limit;
	$limit = "and ballot.judge = ".int($judge_id) if $judge_id;

	my $dbh = Tab::DBI->db_Main();

	my $student_sth = $dbh->prepare("
		select
			student.id, student.first, student.last
			from student, entry_student es, ballot
		where ballot.panel = ?
			and ballot.entry = es.entry
			and es.student = student.id
	");

	$student_sth->execute($panel_id);

	my $student_ref = $student_sth->fetchall_hash();
	my %students = map {$_->{"id"} => $_} @{$student_ref};

	my $sth = $dbh->prepare("
		select
			ballot.id, ballot.side,
			entry.id entry, entry.code, entry.name,
			judge.id judge, judge.first, judge.last,
			score.tag, score.value, score.content,
			ballot_rubric.value_text rubric,
			aff_label.value aff,
			neg_label.value neg

		from (ballot, entry, score, event_setting ballot_rubric)

			left join judge on ballot.judge = judge.id
			left join event_setting aff_label on aff_label.event = entry.event and aff_label.tag = 'aff_label'
			left join event_setting neg_label on neg_label.event = entry.event and neg_label.tag = 'neg_label'

		where ballot.panel = ?
			and ballot.entry = entry.id
			and entry.event = ballot_rubric.event
			and ballot_rubric.tag = 'ballot_rubric'
			and ballot.id = score.ballot
			and score.tag = 'rubric'
			$limit

		group by ballot.id
	");

	$sth->execute($panel_id);

	my $results_ref = $sth->fetchall_hash();

	return unless $results_ref;

	foreach my $result (@{$results_ref}) {

		my $score = eval {
			return JSON::decode_json($result->{"content"});
		};

		my $rubric = eval {
			return JSON::decode_json($result->{"rubric"});
		};

</%init>
		<span class="pagehalf">

			<h6 class="blueborderbottom">
				<% $result->{"code"} %> <% $result->{'side'} == 1 ? $result->{'aff'} : $result->{'neg'} %>
			</h6>

%			Tab::debuglog(JSON::encode_json($rubric));

%			foreach my $order (sort {$a <=> $b} keys %{$rubric->{$result->{"side"}}}) {

%				my $row = $rubric->{$result->{'side'}}{$order};
%				$row->{"label"} =~ s/Defense//g;
%				$row->{"label"} =~ s/Prosecution//g;

				<div class="ltborderbottom odd">
					<span class="twothirds">
						<span class="tenth nospace">
							<% $order %>
						</span>
						<% $row->{"label"} %>
					</span>

					<span class="quarter">
%						if ($score->{$order}{'speaker'} > 0) {
							<% $students{$score->{$order}{"speaker"}}{"first"}." ".$students{$score->{$order}{"speaker"}}{"last"} %>
%						}
					</span>

					<span class="tenth nospace centeralign">
						<% $row->{"mult"}
							? $row->{"mult"} * $score->{$order}{'points'}
							: $score->{$order}{'points'}
						%>
					</span>
				</div>
%			}
		</span>
%	}

