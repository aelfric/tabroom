<%args>
	$person
	$person_settings
	$circuit_id
	$iterations => 8
</%args>
<%init>

	my $circuit = Tab::Circuit->retrieve($circuit_id);
	my $qualifiers = $circuit->setting("qualifiers");

</%init>

	<& menu.mas,
		circuit => $circuit,
		whoami  => "qualifiers"
	&>

	<div class="main">

		<h4>Qualifiers</h4>

%		foreach my $key (keys %{$qualifiers}) {
%			next if $key eq "lastkey";
%			my $qualifier = $qualifiers->{$key};
			<div class="bluebordertop martopmore">
				<div class="row">
					<span class="quarter semibold">
						Set Label
					</span>
					<span class="threequarters">
						<input
							type        = "text"
							size        = "32"
							name        = "label_<% $key %>"
							value       = "<% $qualifier->{label} %>"
							placeholder = "User-readable label like 'State Speech Rules' or 'TOC Octos Bid'"
						>
					</span>
				</div>
				<div class="row">
					<span class="eighth semibold">
						Event Codes
					</span>
					<span class="eighth">
						<input
							type         = "text"
							name         = "event_code"
							circuit_id   = "<% $circuit->id %>"
							qualifier_id = "<% $key %>"
							action       = "add"
							placeholder  = "Add event"
							onKeyDown    = "postEnter(event, this, 'qualifier_event.mhtml');"
						>
					</span>
					<span class="threequarters">
%						foreach my $event (@{$qualifier->{'events'}}) {
							<span
								class        = "quarter yellowhover"
								circuit_id   = "<% $circuit->id %>"
								qualifier_id = "<% $key %>"
								event_code   = "<% $event->{code} %>"
								action       = "rm"
								onClick      = "postSwitch(this, 'qualifier_event.mhtml');"
							>
								<% $event->{'code'} %>
								<% $event->{'level'}  %>
								<% $event->{'nsda'}  %>
							</span>
%						}
					</span>

				</div>

				<h6 class="martopmore">
					Rules
				</h6>
				<div class="yellowrow semibold smallish padvert">
					<div class="sixth">
						# Entries
					</div>
					<div class="sixth">
						# Schools
					</div>

					<span class="twothirds borderleft">
						<div class="quarter" title="Final overall placement in results">
							Placement
						</div>
						<div class="quarter" title="Last elim # reached BEFORE end. So final = 1, semis = 2, quarters = 3">
							Reverse Elim
						</div>
						<div class="quarter" title="How many qualifying points or bids are earned?">
							Points/Bids
						</div>
					</span>
				</div>
<%perl>
				foreach my $set_tick (sort {
					$a->{placement} <=> $b->{placement}
					|| $a->{reverse_elim} cmp $b->{reverse_elim}
				} (@{$qualifier->{ruleset}} , "new") ) {

					my $set;

					if ($set_tick eq "new") {
						$set = ({
							key          => "new",
							placement    => "",
							reverse_elim => "",
							points       => 1
						});
					} else {
						$set = $set_tick;
					}

					my $set_key = $set->{'key'};
</%perl>
					<div class="row">
						<div class="sixth">
							<input
								type  = "number"
								name  = "<% $set_key %>_entries"
								min   = 0
								max   = 99999
								value = "<% $set->{"entries"} %>"
							>
						</div>
						<div class="sixth">
							<input
								type  = "number"
								name  = "<% $set_key %>_entries"
								min   = 0
								max   = 99999
								value = "<% $set->{"entries"} %>"
							>
						</div>

						<span class="twothirds borderleft">
<%perl>
							foreach my $rule_tick (sort {
								$a->{placement} <=> $b->{placement}
								|| $a->{reverse_elim} cmp $b->{reverse_elim}
							} (@{$set->{rules}}, "new") ) {

								my $rule;

								if ($rule_tick eq "new") {
									$rule = ({
										key          => "new",
										placement    => "",
										reverse_elim => "",
										points       => 1
									});
								} else {
									$rule = $rule_tick;
								}

								my $rule_key = $rule->{'key'};
</%perl>
								<div class="quarter">
									<input
										type  = "number"
										name  = "<% $set_key %>_<% $rule_key %>_placement"
										id    = "<% $set_key %>_<% $rule_key %>_placement"
										min   = 0
										max   = 99999
										value = "<% $rule->{"placement"} %>"
									>
								</div>
								<div class="quarter">
									<input
										type  = "number"
										name  = "<% $set_key %>_<% $rule_key %>_reverse_elim"
										id    = "<% $set_key %>_<% $rule_key %>_reverse_elim"
										min   = 0
										max   = 99999
										value = "<% $rule->{"reverse_elim"} %>"
									>
								</div>
								<div class="quarter">
									<input
										type  = "number"
										name  = "<% $set_key %>_<% $rule_key %>_points"
										id    = "<% $set_key %>_<% $rule_key %>_points"
										min   = 0
										max   = 99999
										value = "<% $rule->{"points"} %>"
									>
								</div>
%							}
						</span>
					</div>
%				}
			</div>
%		}

		<form
			action = "qualifier_add.mhtml"
			method = "post"
		>
			<input
				type  = "hidden"
				name  = "circuit_id"
				value = "<% $circuit_id %>"
			>

			<div class="row martopmore bluebordertop">
				<span class="fifth">
					Add new set called
				</span>
				<span class="threefifths">
					<input
						type        = "text"
						name        = "label"
						size        = "64"
						placeholder = "Description, like Octafinals Bid or State IE"
					>
				</span>
				<span class="fifth centeralign">
					<input
						type  = "submit"
						value = "Add"
					>
				</span>
			</div>
		</form>
	</div>


