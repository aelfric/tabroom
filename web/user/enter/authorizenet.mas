<%args>
	$person
	$tourn
	$tourn_settings
	$total
	$school
</%args>

%	my $payment_fee = Math::Round::nearest(.01, $total * .04);
%	my $new_total = $total + $payment_fee;

	<div class="full martopmore rightalign">
		<span class="threefifths top explain biggish bluetext semibold martop">
			<p>
				IMPORTANT NOTE: Online payments will not include missing judge
				fees unless you have requested tournament hires and
				they have been approved.
			</p>

			<p>
				Payments will include a 4% non-refundable processing
				fee. Authorize.net does not refund transaction fees, so be sure
				you are paying the correct amount, as fees from overpayments will
				not be refunded. The minimum for an online payment is $10.
			</p>

		</span>
		<span class="twofifths martop">
			<div class="odd full leftalign">
				<span class="twothirds semibold redtext">
					<span class="spacer"></span>
					Payment amount
				</span>
				<span class="third rightalign marleft">
					<input
						id       = "authorizenet_base"
						type     = "number"
						step     = ".01"
						max      = "<% sprintf('%.2f', $total) %>"
						value    = "<% sprintf('%.2f', $total) %>"
						onChange = "calculateProcessing()";
					>
				</span>
			</div>
			<div class="even full leftalign">
				<span class="twothirds semibold redtext">
					<span class="spacer"></span>
					Processing Fee
				</span>
				<span
					class = "third rightalign code padvertmore padright smallish"
					id    = "processing"
				>
				</span>
			</div>
			<div class="odd full marbottom leftalign">
				<span class="twothirds semibold redtext">
					<span class="spacer"></span>
					Total Charge
				</span>
				<span
					class = "third rightalign code padvertmore padright smallish"
					id    = "new_total"
				>
				</span>
			</div>

			<button
				type="button"
				class="AcceptUI submit"
				style="width: 150px; height: 50px;"
				data-billingAddressOptions='{"show":true, "required":false}' 
				data-apiLoginID="<% $tourn_settings->{"authorizenet_api_login"} %>"
				data-clientKey="<% $tourn_settings->{"authorizenet_client_key"} %>"
				data-acceptUIFormBtnTxt="Submit" 
				data-acceptUIFormHeaderTxt="Payment Information"
				data-paymentOptions='{"showCreditCard": true, "showBankAccount": true}' 
				data-responseHandler="responseHandler"
			>
				Pay Now
			</button>
		</span>

		<span class="tenth"></span>
	</div>

	<script type="text/javascript" src="https://js.authorize.net/v3/AcceptUI.js" charset="utf-8"></script>

	<script type="text/javascript">
		$(document).ready( () => {
			calculateProcessing();
		});

		function calculateProcessing() {

			const max = parseFloat($('#authorizenet_base').attr('max'));
			let base  = parseFloat($('#authorizenet_base').val());

			if (base > max) {
				base = max;
				$('#authorizenet_base').val(base);
				alertify.alert('warning',
					'You may not pay more than the total entry fees online. Missing judge fees are NOT tournament fees. Request judge hires or meet judge obligations to make these fines disappear.');
			}

			if (base < 10) {
				base = 10;
				$('#authorizenet_base').val(base);
			}

			const processing = base * .04;
			const total      = processing + base;

			$('#processing').html(processing.toFixed(2));
			$('#new_total').html(total.toFixed(2));
		}

		async function responseHandler(response) {
			if (response.messages.resultCode === "Error") {
				var i = 0;
				const message = '';
				while (i < response.messages.message.length) {
					message = response.messages.message[i].code + ": " +
						response.messages.message[i].text;
					i = i + 1;
				}
				alertify.alert('warning', 'Payment authorization failed.  Please try again.');
				return false;
			} else {
				const base  = parseFloat($('#authorizenet_base').val());
				const processing = base * .04;
				const total      = processing + base;

				const orderData = { ...response };
				orderData.tourn = <% $tourn->id %>;
				orderData.tourn_name = "<% $tourn->name %>";
				orderData.school = <% $school->id %>;
				orderData.school_name = "<% $school->name %>";
				orderData.person_id = <% $person->id %>;
				orderData.person_email = "<% $person->email %>";
				orderData.total	= total;
				orderData.base = base;
				orderData.processing_fee = processing;

				try {
					const response = await fetch('<% $Tab::indexcards_url %>/user/enter/authorize', { method: 'POST', body: JSON.stringify(orderData), headers: { 'Content-Type': 'application/json' }});
					const json = await response.json();
					if (response.status === 200) {
						window.location = '/user/enter/fees.mhtml?school_id=<% $school->id %>&msg="Successfully recorded payment"';
					} else {
						window.location = '/user/enter/fees.mhtml?school_id=<% $school->id %>&msg="Failure recording payment"';
					}
				} catch (err) {
					console.log(err);
					window.location = '/user/enter/fees.mhtml?school_id=<% $school->id %>&msg="Failure recording payment"';
				}
			}
		}
	</script>
