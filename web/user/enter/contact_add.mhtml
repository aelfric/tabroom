<%args>
	$person
	$school
	$contact_id    => undef
	$contact_email => undef
</%args>
<%init>

	my $msg;


	if ($contact_id) {

		my $contact = Tab::Person->retrieve($contact_id);

		my @already = Tab::Contact->search(
			school => $school,
			person => $contact->id
		);

		if (@already) {

			$msg .= $contact->email." is already a contact";

		} else {
			Tab::Contact->create({
				school     => $school,
				person     => $contact_id,
				created_by => $person,
				created_at => DateTime->now()
			});

			$msg .= "Added ".$contact->email." to your contacts list";
		}
	}

	if ($contact_email) {

		my $contact = Tab::Person->search( email => $contact_email )->first;

		if ($contact) {

			my @already = Tab::Contact->search(
				school => $school,
				person => $contact->id
			);

			if (@already) {

				$msg .= $contact->email." is already a contact";

			} else {

				Tab::Contact->create({
					school     => $school,
					person     => $contact_id,
					created_by => $person,
					created_at => DateTime->now()
				});

				$msg .= "Added ".$contact->email." to your contacts list";
			}
		}
	}

	$m->redirect("entry.mhtml?school_id=".$school->id."&msg=$msg");

</%init>
