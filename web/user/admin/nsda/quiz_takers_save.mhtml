<%args>
	$person
	$quiz_id
</%args>
<%init>

	use Text::CSV;

	my $req = Apache2::Request->new($r);
	my @csv_handles = $r->upload();
	my $csv_file = $req->upload($csv_handles[0]);

	my $quiz = Tab::Quiz->retrieve($quiz_id);

	my %quizzes;
	my $dbh = Tab::DBI->db_Main();
	my @keepers;
	my $success;
	my $already;

	if ($csv_file) {

		my $update_sth = $dbh->prepare('
			update person_quiz pq, person
				set pq.approved_by = ?, updated_at = NOW()
			where person.email = ?
				and pq.person = person.id
		');

		my $find_sth = $dbh->prepare('
			select
				person.id person, pq.id pq, pq.approved_by approved, person.email
			from person
				left join person_quiz pq on pq.person = person.id and pq.quiz = ?
			where person.email = ?
		');

		my $insert_sth = $dbh->prepare('
			insert
				into person_quiz (person, quiz, completed, approved_by, updated_at)
				values (?, ?, 1, ?, NOW() )
		');

		my $counter;
		my $io = $csv_file->io;

		my @refs = <$io>;
		my @lines;

		foreach (@refs) {
			$_ =~ s/[\r]+/\n/g;
			$_ =~ s/[\r\n]+/\n/g;
			$_ =~ s/[\n]+/\n/g;
			push @lines, split (/\n/, $_);
		}

		LINE:
		foreach my $line (@lines) {

			$counter++;

			(
				$quizzes{$counter}{user_id},
				$quizzes{$counter}{name},
				$quizzes{$counter}{email},
				$quizzes{$counter}{quiz_id},
				$quizzes{$counter}{quiz_title},
				$quizzes{$counter}{score},
				$quizzes{$counter}{total},
				$quizzes{$counter}{date},
				$quizzes{$counter}{points},
				$quizzes{$counter}{points_total},
				$quizzes{$counter}{percentage},
				$quizzes{$counter}{time_spent},
				$quizzes{$counter}{passed},
				$quizzes{$counter}{course_id},
				$quizzes{$counter}{course_title}
			) = split(/,/, $line);
		}

		KEY:
		foreach my $key (keys %quizzes) {

			next unless $quizzes{$key}{passed} eq "YES";

			$find_sth->execute($quiz_id, $quizzes{$key}{email});

			my $results = $find_sth->fetchall_hash();

			if ($results && @{$results}) {

				my $ref = shift @{$results};

				if ($quizzes{$key}{"email"} eq 'alexjvweaver7@gmail.com') {
					Tab::debuglog("found approval for ".$ref->{email});
				}

				if ($ref->{approved}) {
					$already++;
				} elsif ($ref->{pq}) {
					$update_sth->execute($person->id, $quizzes{$key}{email});
					$success++;
				} elsif ($ref->{person}) {
					$insert_sth->execute($ref->{person}, $quiz_id, $person->id);
					$success++;
				} else {
					push @keepers, $key;
				}
			} else {

				if ($quizzes{$key}{"email"} eq 'alexjvweaver7@gmail.com') {
					Tab::debuglog("found nobody for weaver");
				}
				push @keepers, $key;
			}
		}
	}

</%init>

	<div class="main">

		<div class="flexrow nospace full">
			<span class="threefifths">
				<h5><% $quiz->label %></h5>
			</span>
			<span
				class = "threetenths rightalign"
			>
				<% $already || 0 %> records already approved <br />
				<% $success || 0 %> records updated
			</span>
			<span
				class = "tenth rightalign"
				id    = "quiz_<% $quiz->tag %>_buttonarea"
			>
			</span>
		</div>

		<p class="centeralign semibold biggish redtext">
			No matches found for the following records
		</p>

		<& "/funclib/tablesorter.mas", table => "quiz_".$quiz->tag &>

		<table id="quiz_<% $quiz->tag %>" class="fixed">

			<thead>
				<tr class="yellowrow">
					<th>
						user_id
					</th><th>
						name
					</th><th>
						email
					</th><th>
						quiz_id
					</th><th>
						quiz_title
					</th><th>
						score
					</th><th>
						total
					</th><th>
						date
					</th><th>
						points
					</th><th>
						points_total
					</th><th>
						percentage
					</th><th>
						time_spent
					</th><th>
						passed
					</th><th>
						course_id
					</th><th>
						course_title
					</th>
				</tr>
			</thead>

			<tbody>
%				foreach my $key (sort {$a <=> $b} @keepers) {

					<tr>
						<td>
							<% $quizzes{$key}{user_id} %>
						</td><td>
							<% $quizzes{$key}{name} %>
						</td><td>
							<% $quizzes{$key}{email} %>
						</td><td>
							<% $quizzes{$key}{quiz_id} %>
						</td><td>
							<% $quizzes{$key}{quiz_title} %>
						</td><td>
							<% $quizzes{$key}{score} %>
						</td><td>
							<% $quizzes{$key}{total} %>
						</td><td>
							<% $quizzes{$key}{date} %>
						</td><td>
							<% $quizzes{$key}{points} %>
						</td><td>
							<% $quizzes{$key}{points_total} %>
						</td><td>
							<% $quizzes{$key}{percentage} %>
						</td><td>
							<% $quizzes{$key}{time_spent} %>
						</td><td>
							<% $quizzes{$key}{passed} %>
						</td><td>
							<% $quizzes{$key}{course_id} %>
						</td><td>
							<% $quizzes{$key}{course_title} %>
						</td>
					</tr>
%				}
			</tbody>
		</table>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Return</h4>

			<a
				class = "full blue"
				href  = "quiz_takers.mhtml?quiz_id=<% $quiz_id %>"
			>Return to <% $quiz->tag %></a>

		</div>

	</div>
