<%args>
	$person
	$person_settings
	$quiz_id => undef
</%args>
<%init>

	my $quiz = Tab::Quiz->retrieve($quiz_id);

	unless ($quiz) {
		$m->comp("/funclib/abort.mas", message => "No valid certification ID sent");
	}

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select
			person.id person_id, person.first, person.last, person.email,
			pq.id id, pq.hidden, pq.pending, pq.approved_by, pq.completed completed, pq.updated_at,
			approved_by.first approved_first, approved_by.last approved_last, approved_by.email approved_email

		from (person, person_quiz pq)
			left join person approved_by on approved_by.id = pq.approved_by

		where person.id = pq.person
			and pq.quiz = ?
		order by pq.updated_at
	");

	$sth->execute($quiz_id);

	my $approve_sth = $dbh->prepare("
		update person_quiz set approved_by = ? where id = ?
	");

	my $complete_sth = $dbh->prepare("
		update person_quiz set completed = ? where id = ?
	");

	my $resync_sth = $dbh->prepare("
		update person_quiz set pending = 1 where approved_by IS NOT NULL and approved_by != 0
	");

	my $results = $sth->fetchall_hash();

	if ($ARGS{"save_me"}) {

		foreach my $result (@{$results}) {

			my $id = $result->{"id"};

			$ARGS{$id."_approved"} = 0 unless $ARGS{$id."_approved"};
			$ARGS{$id."_completed"} = 0 unless $ARGS{$id."_completed"};

			if ($ARGS{$id."_approved"}) {
				if ($person->id != $result->{"approved_by"}) {
					$approve_sth->execute($person->id, $id);
					$result->{"approved_by"} = $person->id;
					$result->{"approved_email"} = $person->email;
				}
			} elsif ($result->{"approved_by"} > 1) {
				$approve_sth->execute(0, $id);
				$result->{"approved_by"} = 0;
				$result->{"approved_email"} = "";
			}

			$ARGS{$id."_completed"} = 0 unless $ARGS{$id."_completed"};

			if ($ARGS{$id."_completed"} ne $result->{"completed"}) {
				$complete_sth->execute($ARGS{$id."_completed"}, $id);
				$result->{"completed"} = $ARGS{$id."_completed"};
			}
		}

		$resync_sth->execute();
	}

</%init>

	<script>

		function approveAll() {
			$('.approvals').prop('checked', true);
		}

	</script>

	<& ../menu.mas,
        person          => $person,
        person_settings => $person_settings,
        whoami          => "questionnaires"
    &>

	<div class="main">

		<& "/funclib/tablesorter.mas", table => "quiz" &>

		<span class="threequarters nospace">
			<h4><% $quiz->label %></h4>
		</span>

		<span class="quarter rightalign" id="quiz_buttonarea">
			<a
				class="fa fa-sm fa-check buttonwhite bluetext marright"
				title="Approve All"
				onClick="approveAll();"
			></a>
		</span>

		<form
			action = "quiz_takers.mhtml"
			method = "post"
		>

		<input
			type  = "hidden"
			name  = "quiz_id"
			value = "<% $quiz->id %>"
		>

		<input
			type  = "hidden"
			name  = "save_me"
			value = "1"
		>

		<table id="quiz">

			<thead>
				<tr class="yellowrow">
					<th class="marvertless">
						First
					</th>

					<th>
						Last
					</th>

					<th>
						Email
					</th>

					<th>
						Complete
					</th>

					<th>
						Last Updated
					</th>

					<th title="Hidden from appearing on their paradigm">
						Hidden
					</th>

%					if ($quiz->approval) {
						<th>
							Approved By
						</th>

						<th>
							Approve
						</th>
%					}
				</tr>
			</thead>

			<tbody>

%				foreach my $result (@{$results}) {

					<tr class="smallish">
						<td>
							<% $result->{"first"} %>
						</td>

						<td>
							<% $result->{"last"} %>
						</td>

						<td>
							<% $result->{"email"} %>
						</td>

						<td class="centeralign nospace">
							<span class="hiddencsv">
								<% $result->{"completed"} ? "Y" : "N" %>
							</span>
							<label for="<% $result->{"id"} %>_completed">
								<div class="full padvertno hover marno">
									<input
										type  = "checkbox"
										class = "marvertless"
										name  = "<% $result->{"id"} %>_completed"
										id    = "<% $result->{"id"} %>_completed"
										value = "1"
										<% $result->{"completed"} ? "checked" : "" %>
									>
								</div>
							</label>
						</td>

						<td>
							<& "/funclib/showdt.mas",
								string => $result->{"updated_at"},
								tz     => "America/Chicago",
								length => "sortable"
							&>
						</td>

						<td class="centeralign">
							<% $result->{"hidden"} ? "Y" : "N" %>
						</td>

%						if ($quiz->approval) {
							<th>
								<% $result->{"approved_by"}
									? $result->{"approved_email"}
									:""
								%>
							</th>

							<th class="centeralign">
								<label for="<% $result->{"id"} %>_approved">
									<div class="full padvertno hover marno">
										<input
											type  = "checkbox"
											class = "approvals"
											name  = "<% $result->{"id"} %>_approved"
											id    = "<% $result->{"id"} %>_approved"
											value = "1"
											<% $result->{"approved_by"} ? "checked" : "" %>
										>
									</div>
								</label>
							</th>
%						}
					</tr>
%				}
			</tbody>

		</table>

		<div class="full liblrow rightalign">
			<span class="quarter centeralign">
				<input type="submit" value="Save">
			</span>
		</div>

		</form>

	</div>
