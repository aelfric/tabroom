<%args>
	$person
	$person_settings
</%args>
<%init>



</%init>

	<& menu.mas,
		person          => $person,
		person_settings => $person_settings,
		whoami          => "servers"
	&>

	<div class="main">

		<div class="full flexrow ltborderbottom padvert">
			<span class="half nospace">
				<h4 class="nospace">
					Current Tabroom Server Status
				</h4>
			</span>
			<span class="half rightalign">
				<p class="semibold bluetext">The Burdt Button&trade;</p>
			</span>
		</div>

		<h6 class="ltborderbottom padtopmore">
			Current User Numbers
		</h6>

		<div class='flexrow row'>
			<span class="third semibold padvert padleft">
				Total Active Tournaments
			</span>

			<span class="sixth" id="total_tournaments">
			</span>

			<span class="third semibold padleft">
				Daily Active Users
			</span>

			<span class="sixth" id="active_users">
			</span>
		</div>

		<div class='flexrow row'>
			<span class="third semibold padvert padleft">
				Current Tournament Competitors
			</span>

			<span class="sixth" id="active_students">
			</span>

			<span class="third semibold padleft">
				Current Tournament Judges
			</span>

			<span class="sixth" id="active_judges">
			</span>
		</div>

		<h6 class="ltborderbottom padtopmore">
			Current Server Status
		</h6>

		<div class='flexrow full semibold ltyellow'>

			<span class="sixth padleft">
				Server
			</span>

			<span class="sixth centeralign smallish">
				State
			</span>

			<span class="tenth centeralign smallish">
				CPU 1m
			</span>

			<span class="tenth centeralign smallish">
				CPU 5m
			</span>

			<span class="tenth centeralign smallish">
				CPU 15m
			</span>

			<span class="tenth centeralign smallish">
				Mem Used
			</span>

			<span class="tenth centeralign smallish">
				Swap Used
			</span>

			<spav class="tenth centeralign smallish">
				Reboot
			</span>
		</div>

		<div id="server_status">

		</div>

	</div>

	<script>

		$(document).ready( () => {
			checkServerUsage();
			serverList();
		});

		function checkServerUsage() {
			$.ajax({
				type        : 'GET',
				url         : '<% $Tab::indexcards_url %>/glp/servers/usage',
				crossDomain : true,
				xhrFields : {
					withCredentials : true
				},
				success     : (usage) => {
					$(`#active_judges`).text(usage.judges);
					$(`#active_students`).text(usage.students);
					$(`#total_tournaments`).text(usage.tournaments);
					$(`#active_users`).text(usage.activeUsers);
				},
				failure : (err) => {
					alert.altertify('warning', err);
				}
			});
		};

		function serverList() {
			$.ajax({
				type        : 'GET',
				url         : '<% $Tab::indexcards_url %>/glp/servers/show',
				crossDomain : true,
				xhrFields : {
					withCredentials : true
				},
				success     : (servers) => {

					console.log(`I have ${servers.length} servers`);

					$('#server_status').text('');

					for (const server of servers) {

						const row = `
							<div class="row flexrow">
								<span class="sixth semibold padleft padvert">
									${server.label}
								</span>

								<span class="sixth smallish semibold centeralign" id="${ server.linode_id }_stats">
									${server.status}
								</span>

								<span class="tenth centeralign smallish" id="${ server.linode_id }_cpu1m">
								</span>

								<span class="tenth centeralign smallish" id="${ server.linode_id }_cpu5m">
								</span>

								<span class="tenth centeralign smallish" id="${ server.linode_id }_cpu15m">
								</span>

								<span class="tenth centeralign smallish" id="${ server.linode_id }_mem">
								</span>

								<span class="tenth centeralign smallish" id="${ server.linode_id }_swap">
								</span>

								<span class="tenth centeralign smallish" id="${ server.linode_id }_reboot">
								</span>
							</div>
						`;

						console.log(row);
						$('#server_status').append(row);
						fixVisual();
					}
				},
				failure : (err) => {
					alert.altertify('warning', err);
				}
			});
		};



	</script>
