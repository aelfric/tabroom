<%init>

	my $target_event = Tab::Event->retrieve(250233);

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select
			score.id score, score.value, score.student, ndtentry.id entry, ndtentry.code code

		from score, ballot, panel, round, event, tourn, tourn_circuit tc,
			entry, entry_student es, entry_student ndt_es, entry ndtentry

		where ndtentry.event = ?
			and ndtentry.id = ndt_es.entry
			and ndt_es.student = es.student
			and es.entry = entry.id
			and entry.event = event.id
			and event.tourn = tourn.id
			and tourn.start > '2022-08-01 00:00:00'
			and tourn.id = tc.tourn
			and tc.circuit = '42'
			and event.id = round.event
			and round.id = panel.round
			and panel.id = ballot.panel
			and ballot.id = score.ballot
			and score.tag = 'point'
			and score.value > 25
	");

	$sth->execute($target_event->id);

	my $results = $sth->fetchall_hash();

	my %team_points;
	my %done;

	foreach my $result (@{$results}) {
		next if $done{$result->{score}}++;
		$team_points{$result->{entry}}{total} += $result->{points};
		$team_points{$result->{entry}}{count}++;
		$team_points{$result->{entry}}{code} = $result->{code};
	}

	foreach my $entry (keys %team_points) {

		my $avg = $team_points{$entry}{"total"} / $team_points{$entry}{"count"}
			if $team_points{$entry}{"count"};

		$m->print("<p>".$team_points{$entry}{"code"}." has average points ".$avg."</p>");
		$m->flush_buffer();
	}

</%init>

