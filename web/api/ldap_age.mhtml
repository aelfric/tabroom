<%args>

</%args>
<%init>

	my $now = DateTime->now();
	$now->subtract(years => 2);

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select
			person.id, person.email, person.first, person.last

		from person
			where not exists (
				select ps.id
				from person_setting ps
				where ps.tag = 'last_access'
				and ps.value_date > ?
				and ps.person = person.id
			)

		limit 91000
	");

	$sth->execute(DateTime::Format::MySQL->parse_datetime($now));

	my $results = $sth->fetchall_hash();

	my $count;

	$m->clear_buffer();

	$m->print("<h3>Yes, I have found ".(scalar @{$results})." results</h3>");
		$m->flush_buffer();

	foreach my $ref (@{$results}) {

		$m->print("<p>".$ref->{id}." ".$ref->{email}." - ".$ref->{"last"}."</p>\n");
		if ($count++ > 100) {
			undef $count;
			$m->flush_buffer();
		}
	}

	$m->print("<h3>Fin</h3>");

</%init>
