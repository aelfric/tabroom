<%args>
	$tourn
	$tourn_settings
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();

	# Find the LCQ

	my $lcq_sth = $dbh->prepare("
		select tourn.id, tourn.name
			from tourn, tourn_setting ts
		where ts.tag = 'nsda_district'
			and ts.value = '999'
			and ts.tourn = tourn.id
			and tourn.start < ?
		order by tourn.start DESC limit 1
	");

	$lcq_sth->execute(DateTime::Format::MySQL->format_datetime($tourn->start));
	my ($lcq_id, $lcq_name) = $lcq_sth->fetchrow_hash();

	$lcq_sth->finish;

	my $sth = $dbh->prepare("
		select
			school.id, school.name, chapter.state,
				district.code dcode, district.name district,
			count(lcq.id) as lcq_count,
			count(nats.id) as nats_count

		from (school, chapter, district)

			left join entry nats on nats.school = school.id
				where nats.school = school.id
				and not exists (
					select es.id from entry_setting es
					where es.tag= 'lastchance'
					and es.entry = nats.id
				)
				and not exists (
					select evs.id from event_setting evs
					where evs.tag= 'supp'
					and evs.event = nats.event
				)

			left join entry lcq
				where lcq.school = school.id
				and exists (
					select es.id from entry_setting es
					where es.tag= 'lastchance'
					and es.entry = nats.id
				)
				and not exists (
					select evs.id from event_setting evs
					where evs.tag= 'supp'
					and evs.event = nats.event
				)
		where school.tourn = ?
			and school.chapter = chapter.id
			and school.district = district.id
		order by chapter.state, school.name
	");

	$sth->execute($tourn);
	my $already_quals = $sth->fetchall_hash();

</%init>

	<div class="main">

		<h2>Burdt's Shit from <% $lcq_name %></h2>

		<span class="threequarters nospace">
			<h5>
				Schools With Other Qualifiers
			</h5>
		</span>

		<& "/funclib/tablesorter.mas", table => "other_quals" &>

		<span
			class="quarter rightalign nospace"
			id="buttonarea_other_quals"
		></span>

		<table id="other_quals">
			<thead>
				<tr class="yellowrow">
					<th>
						School
					</th>
					<th>
						State
					</th>
					<th>
						District
					</th>
					<th>
						Qualifiers
					</th>
					<th>
						LCQ Qualifiers
					</th>
				</tr>
			</thead>

			<tbody>
%				foreach my $school (@{$already_quals}) {
%					next unless $school->{"lcq_count"} || $school->{"nats_count"};
					<tr class="smallish">
						<td>
							<% $school->{'name'} %>
						</td>
						<td>
							<% $school->{'state'} %>
						</td>
						<td>
							<% $school->{'district'} %>
						</td>
						<td>
							<% $school->{'nats_count'} %>
						</td>
						<td>
							<% $school->{'lcq_count'} %>
						</td>
					</tr>
%				}
			</tbody>
		</table>


		<& "/funclib/tablesorter.mas", table => "tablename" &>

		<span class="threequarters nospace">
			<h5>
				Schools With Other Qualifiers
			</h5>
		</span>
		<span
			class="quarter rightalign nospace"
			id="buttonarea_tablename"
		></span>

		<table id="tablename">
			<thead>
				<tr class="yellowrow">
					<th>
						School
					</th>
					<th>
						State
					</th>
					<th>
						District
					</th>
					<th>
					</th>
					<th>
					</th>
					<th>
					</th>
				</tr>
			</thead>

			<tbody>
				<tr>
				</tr>
			</tbody>
		</table>
	</div>


