<%args>
	$tourn
	$perms
	$session
	$person
	$tourn_settings => undef
	$only_category  => undef
	$defaults       => undef
	$checker        => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $dbh = Tab::DBI->db_Main();

	my %dashboard_events = eval {
		return %{$defaults->{dashboard_events}};
	};

	my $sth = $dbh->prepare("
		select event.id, event.name, event.abbr
			from (event)
			left join event_setting supp
				on supp.event = event.id
				and supp.tag = 'supp'
		where event.tourn = ?
			and event.type != 'attendee'
		order by supp.value, event.type, event.abbr
	");

	$sth->execute($tourn->id);
	my $events = $sth->fetchall_hash();

	my $length = length($tourn->name);

</%init>

	<div class="blankfull">

		<div class="nospace">
			<span class="twothirds semibold">
				<h5 class="scalefont">
					<% $tourn->name %>
				</h5>
			</span>

			<span class="third rightalign nospace">
				<h4>
					Status Dashboard
				</h4>
			</span>
		</div>

%		if ($checker) {
			<div class="full nospace borderbottom">
			</div>
%		} else {
			<& "tabbar.mas",
				whoami         => 'dashboard',
				tourn          => $tourn,
				tourn_settings => $tourn_settings
			&>
%		}

		<div class="nospace">
			<span class="third nospace">
				<h4>Event Status</h4>
			</span>

			<span class="third centeralign nospace">
				<h6
					id    = "clock"
					title = "Current tournament time"
					class = "semibold bluetext inline borderredmed padmore"
				></h6>
			</span>

			<span class="third rightalign nospace">
				<span class="half rightalign semibold bluetext  padsettingtext marbottom" >
					Hide events in
				</span>

				<span class="half leftalign padtop">
					<form
						action = "dashboard_ignore.mhtml"
						method = "post"
					>
						<select
							class    = "fixedmost"
							name     = "category_id"
							onChange = "this.form.submit();";
						>
							<option value=""></option>
%							foreach my $category ($tourn->categories) {
								<option
									value="<% $category->id %>"
								><% $category->name %></option>
%							}
						</select>
					</form>
				</span>
			</span>
		</div>

		<div class="centeralign dropme">
%			foreach my $event (@{$events}) {
				<span
					class = "dragme statusbox hidden"
					id    = "<% $event->{id} %>"
				>
					<h5
						class = "centeralign"
						id    = "<% $event->{id} %>_eventName"
						title = "<% $event->{name} %>"
					><% $event->{abbr} %></h5>

					<div
						class="full nospace"
						id = "<% $event->{id} %>_rounds"
					>
					</div>
				</span>
%			}
		</div>

%		if (keys %dashboard_events) {
			<div class="full rightalign martopmuchmore">
				<a
					class         = "buttonwhite greentext yellowhover padmore semibold"
					property_name = "all"
					on_success    = "refresh"
					onClick       = "postSwitch(this, 'dashboard_ignore.mhtml');"
				>View All Events</a>
			</div>
%		}
	</div>

%#	The below would definitely be easier with React but this is what we have right now

%	my $get_url = "/v1/tourn/".$tourn->id."/tab/status/dashboard";

<!--
	<script>

		function refreshDashboard () {

			$.getJSON('<% $get_url %>', function(rounds) {

				Object.keys(rounds).map( round => {

					const eventId = round.eventId;
					$(`#${event}`).removeClass('hidden');

					Object.keys(round.flights).foreach( flightNum =>  {

						const flight = round.flights[flightNum];
						const flightKey = `${round.roundId}-${flightNum}`:

						// Check if there's a change in status via the data properties
						const currentStatus = $(`#${flightKey}`).attr('current_status');
						const newStatus = `${flightNum}-${flight.done}-${flight.half}-${flight.started}`;

						if (currentStatus == newStatus) {
							return;
						}

						if (!currentStatus) {
							// Create a round container and append it to the list
						}

						// Make it FLASH
						$(`#${flightKey}`).addClass('yellowrow');

						// Clear out the current numbers & replace them.


						// Turn off the flashy flash

					});
				}
			});
		}

		function showDate() {
			var dNow = new Date()
				.toLocaleTimeString('en-US',
					{timeZone: "<% $tourn->tz %>", hour: "numeric", minute: "numeric"}
				);
			$('#clock').text(dNow);
		}

		$(document).ready(function() {
			refreshDashboard();
			showDate();
			setInterval(refreshDashboard, 15000);
			setInterval(showDate, 5000);
		});

		$( function() {
			$( ".dragme" ).draggable({
				start: function( event, ui ) {
					$(this).addClass("statuspick");
					$(this).hide();
				},
				stop: function( event, ui ) {
					$(this).removeClass("statuspick");
					$(this).show();
				},
				disableSelection : true,
				resort  : true,
			}).touch({
				animate : false,
				sticky  : false,
				dragx   : true,
				dragy   : true,
				rotate  : false,
				resort  : true,
				scale   : false,
				start: function( event, ui ) {
					$(this).addClass("statuspick");
					$(this).hide();
				},
				stop: function( event, ui ) {
					$(this).removeClass("statuspick");
					$(this).show();
				},
			});

			$( ".dropme" ).droppable({
				accept : ":not(.ui-sortable-helper)",
				disableSelection : "true",
				greedy           : true,
				drop: function (event, ui) {
					$(this).find( ".placeholder" ).remove();
				}
			});

			$( ".dragme" ).removeClass("ui-draggable");
			$( ".dragme" ).removeClass("ui-draggable-handle");

		}).sortable({
			items: ":not(.placeholder)",
			sort: function() {
				$( this ).removeClass( "ui-state-default" );
			}
		});

	</script>
-->
