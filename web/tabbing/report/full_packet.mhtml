<%args>
	$person
	$person_settings
	$tourn
	$tourn_settings
	$session
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select
			event.id, event.name, event.type,
            code_style.value code_style,
            supp.value supp,
            result_description.value_text result_description,
            bowl_description.value_text bowl_description,
            final_bowl_protocol.value final_bowl_protocol,
            max_entry.value max_entry

        from (event)

            left join event_setting code_style
                on code_style.event = event.id
                and code_style.tag = 'code_style'

            left join event_setting supp
                on supp.event = event.id
                and supp.tag = 'supp'

            left join event_setting result_description
                on result_description.event = event.id
                and result_description.tag = 'result_description'

            left join event_setting bowl_description
                on bowl_description.event = event.id
                and bowl_description.tag = 'bowl_description'

            left join event_setting max_entry
                on max_entry.event = event.id
                and max_entry.tag = 'max_entry'

            left join event_setting final_bowl_protocol
                on final_bowl_protocol.event = event.id
                and final_bowl_protocol.tag = 'final_bowl_protocol'

			where event.tourn = ?
			and event.type != 'congress'
			and event.type != 'wsdc'

		order by supp.value, event.type, event.name
	");

	$sth->execute($tourn->id);
	my $events = $sth->fetchall_hash();

	my $name = $tourn->name;
	$name =~ s/[\W_]//g;
	my $filename = "FinalResults-$name-".$session->id;
	my $filepath = $Tab::file_root."tmp/".$filename;

	$m->comp("/funclib/printout.mas",
		tourn       => $tourn,
		filename    => $filename,
		head        => 1,
		wide        => 1,
		taller      => 1,
		footer_text => $tourn->start->year." ".$tourn->name." -- Raw Results",
		no_footer   => 1,
		array       => "1.1",
		landscape   => 1
	);

	my $texout;

	open ($texout, ">>$filepath.tex");
	binmode($texout, ":utf8");

	foreach my $event (@{$events}) {

		Tab::debuglog("Doing ".$event->{name}." final results");

		if ($event->{type} eq "debate") {

			$m->comp("final_wins.mhtml",
				person          => $person,
				person_settings => $person_settings,
				tourn           => $tourn,
				tourn_settings  => $tourn_settings,
				session         => $session,
				event_id        => $event->{id},
				event_ref       => $event,
				texout          => $texout,
				sort_by         => "finals"
			);

		} else {

			$m->comp("final_cumes.mhtml",
				person         => $person,
				person_settings => $person_settings,
				tourn          => $tourn,
				tourn_settings => $tourn_settings,
				session        => $session,
				event_id       => $event->{id},
				event_ref      => $event,
				texout         => $texout,
				sort_by        => "finals"
			);
		}

		Tab::debuglog("Doing ".$event->{name}." raw results");

		$m->comp("score_report.mhtml",
			person         => $person,
			person_settings => $person_settings,
			tourn          => $tourn,
			tourn_settings => $tourn_settings,
			session        => $session,
			event_id       => $event->{id},
			event_ref      => $event,
			texout         => $texout,
			sort_by        => "finals"
		);

		Tab::debuglog("Done with ".$event->{name});

	}

	close $texout;

    $m->comp("/funclib/printout.mas",
        tourn     => $tourn,
        filename  => $filename,
		landscape => 1,
        tail      => 1
    );

</%init>
