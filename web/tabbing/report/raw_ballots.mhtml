<%args>
	$perms
	$person
	$tourn
	$tourn_settings
	$event_id => undef
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();

	my $wins_sth = $dbh->prepare("
		select
			entry.id, entry.code, entry.name,
			school.id school_id, school.name school_name,
			region.id region_id, region.name region_name,
			round.name round_name, round.label round_label,
			round.type, ballot.id, score.value

		from (entry, school, ballot, score)
			left join region on school.region = region.id

		where entry.event = ?
			and entry.active = 1
			and entry.school = school.id
			and entry.id = ballot.entry
			and ballot.id = score.ballot
			and score.tag = winloss
	");

	my %results;

	$wins_sth->execute($event_id);
	my $wins = $wins_sth->fetchall_hash();

	foreach my $result (@{$results}) {

		next if $result->{round_name} == 5;
		next if $result->{type} eq "final";
		next if $result->{round_label} eq "Play-In";

		$results{$result->{id}}{code} = $result->{code};
		$results{$result->{id}}{name} = $result->{name};
		$results{$result->{id}}{school} = $result->{school_name};
		$results{$result->{id}}{region} = $result->{region_name};

		my $tag;

		if ($result->{value} == 1) {
			$tag = "win";
		} else {
			$tag = "loss";
		}

		$results{$result->{id}}{"all_".$tag}++;

		if (
			$result->{type} eq "prelim"
			|| $result->{type} eq "highlow"
			|| $result->{type} eq "highhigh"
		) {
			$results{$result->{id}}{"prelim_".$tag}++;
		} else {
			$results{$result->{id}}{"elim_".$tag}++;
		}
	}

</%init>

	<& "/funclib/tablesorter.mas", table => "ballots" &>

	<table id="ballots">

		<thead>
			<tr class="yellowrow">
				<th>
					Code
				</th>
				<th>
					Name
				</th>
				<th>
					School
				</th>
				<th>
					Dio
				</th>
				<th>
					Prelim Wins (No 5)
				</th>
				<th>
					Prelim Loss (No 5)
				</th>
				<th>
					Elim Wins
				</th>
				<th>
					Elim Loss
				</th>
				<th>
					Total Wins
				</th>
				<th>
					Total Loss
				</th>
			</tr>
		</thead>

		<tbody>

%			foreach my $id (sort {$a cmp $b} keys %results) {

				<tr class="smallish">
					<td>
						<% $results{$id}{'code'} %>
					</td>
					<td>
						<% $results{$id}{'name'} %>
					</td>
					<td>
						<% $results{$id}{'school_name'} %>
					</td>
					<td>
						<% $results{$id}{'region_name'} %>
					</td>
					<td>
						<% $results{$id}{'prelim_win'} || 0 %>
					</td>
					<td>
						<% $results{$id}{'prelim_loss'} || 0 %>
					</td>
					<td>
						<% $results{$id}{'elim_win'} || 0 %>
					</td>
					<td>
						<% $results{$id}{'elim_loss'} || 0 %>
					</td>
					<td>
						<% $results{$id}{'total_win'} || 0 %>
					</td>
					<td>
						<% $results{$id}{'total_loss'} || 0 %>
					</td>
				</tr>
%			}

		</tbody>

	</table>
