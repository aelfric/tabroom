<%args>
	$tourn
	$tourn_settings
	$person
	$protocol_id => undef
</%args>
<%init>

	my $protocol = Tab::Protocol->retrieve($protocol_id)
		if $protocol_id;

	my %protocol_setting = $protocol->all_settings if $protocol;

</%init>

	<script>

		function showSpecificRound() {

			$(".countSelector").each(function() {

				var protocolID = $(this).attr("protocol");
				var count = $(this).find(":selected").val();

				if (count === "specific") {
					$(".specificbox_"+protocolID).removeClass("hidden");
				} else {
					$(".specificbox_"+protocolID).addClass("hidden");
				}

			});

			fixVisual();
		};

		function showComposites() {

			$(".tbSelector").each(function() {

		        var tiebreaker = $(this).find(":selected").val();
				var protocolID = $(this).attr("protocol");

				if (
					tiebreaker === "ranks"
					|| tiebreaker === "chair_ranks"
					|| tiebreaker === "non_chair_ranks"
					|| tiebreaker === "reciprocals"
					|| tiebreaker === "judgepref"
					|| tiebreaker === "student_rank"
					|| tiebreaker === "student_recip"
					|| tiebreaker === "downs"
				) {

					$(".ranksbox_"+protocolID).removeClass("hidden");
					$(".oppbox_"+protocolID).addClass("hidden");

				} else if (
					tiebreaker === "opp_seed"
					|| tiebreaker === "opp_ranks"
					|| tiebreaker === "opp_wins"
					|| tiebreaker === "opp_points"
				) {

					$(".oppbox_"+protocolID).removeClass("hidden");
					$(".ranksbox_"+protocolID).addClass("hidden");

				} else {

					$(".ranksbox_"+protocolID).addClass("hidden");
					$(".oppbox_"+protocolID).addClass("hidden");
				}
			});

			fixVisual();
		};

		function showCompositeTbs() {

			$(".compositeSelector").each(function() {
		        var checked = $(this).prop("checked");
				var protocolID = $(this).attr("protocol");

				if (checked) {
					$(".compositebox_"+protocolID).removeClass("hidden");
				} else {
					$(".compositebox_"+protocolID).addClass("hidden");
				}
			});

			fixVisual();
		};

		$(document).ready(function(){
			showSpecificRound();
			showComposites();
			showCompositeTbs();
			$(".compositebox").addClass('hidden');
			fixVisual();
		});

	</script>

	<div class="main">

		<h4><% $tourn->name %></h4>

		<& tabbar.mas,
			tourn => $tourn,
			whoami => "tiebreaks"
		&>

		<div class='pagefull nospace'>

			<span class="twothirds nospace semibold">
				<h4><% $protocol ? $protocol->name : "Create Tiebreak Set" %></h4>
			</span>

			<span class="third rightalign">

%				if ($protocol) {

%					my $warn = "You are about to delete this tiebreaker set.  That may cause terrible, terrible damage.  Are you sure?";
					<a
						class = "redtext buttonwhite centeralign nowrap hover"
						href  = "protocol_rm.mhtml?set_id=<% $protocol->id %>"
						title = "Delete <% $protocol->name %> tiebreakers"
						<& "/funclib/confirm.mas", warn => $warn &>
					>
						<span class="inline fa fa-trash"></span>
					</a>
%				}
			</span>

		</div>

		<form
			action = "protocol_save.mhtml"
			method = "post"
		>

		<input
			type  = "hidden"
			name  = "protocol_id"
			value = "<% $protocol_id %>"
		>

		<div class="odd pagefull rightalign">

			<span class="quarter semibold bluetext">
				Name of Tiebreaker Set
			</span>
			<span class="threequarters">
				<input
					type        = "text"
					size        = "64"
					name        = "name"
					value       = "<% $protocol ? $protocol->name : "" %>"
					placeholder = "Tiebreak set name"
				>
			</span>
		</div>

		<span class="pagehalf">
			<div class="row hover">
				<label for="equal_elims">
					<span class="seveneighth">
						<span class="quarterspacer"></span>
						Advance equal entries from each section

						<p class="smallish explain marno padless">
							<span class="halfspacer"></span>
							Use only in IE Elims &amp; Congress
						</p>
					</span>

					<span class="eighth smallish">
						<input
							type  = "checkbox"
							id    = "equal_elims"
							name  = "equal_elims"
							value = "1"
							<% $protocol_setting{"equal_elims"}
								? 'checked="checked"'
								: ""
							%>
						>
					</span>

				</label>
			</div>

			<div class="row hover">
				<label for="forfeits_never_break">
					<span class="seveneighth">
						<span class="quarterspacer"></span>
						Forfeits cannot advance/place last in event
					</span>
					<span class="eighth">
						<input
							type  = "checkbox"
							id    = "forfeits_never_break"
							name  = "forfeits_never_break"
							value = "1"
							<% $protocol_setting{"forfeits_never_break"}
								? 'checked="checked"'
								: ""
							%>
						>
					</span>
				</label>
			</div>

			<div class="row hover" title="This setting will give forfeits the worst rank in the section.  Multiple forfeits mean multiple students will be tied for the last rank">
				<label for="forfeits_rank_last">
					<span class="seveneighth">
						<span class="quarterspacer"></span>
						Forfeits place last in section
					</span>
					<span class="eighth">
						<input
							type  = "checkbox"
							id    = "forfeits_rank_last"
							name  = "forfeits_rank_last"
							value = "1"
							<% $protocol_setting{"forfeits_rank_last"}
								? 'checked="checked"'
								: ""
							%>
						>
					</span>
				</label>
			</div>
		</span>

		<span class="pagehalf">
			<div class="row hover">
				<label for="tie_middle_rank">
					<span class="seveneighth">
						<span class="quarterspacer"></span>
						3x Composite Ties get Middle Rank (CA)
					</span>

					<span class="eighth">
						<input
							type  = "checkbox"
							id    = "tie_middle_rank"
							name  = "tie_middle_rank"
							value = "1"
							<% $protocol_setting{"tie_middle_rank"}
								? 'checked="checked"'
								: ""
							%>
						>
					</span>
				</label>
			</div>
		</span>

		<div class="liblrow pagefull marno rightalign">
			<input
				type  = "submit"
				value = "<% $protocol ? "Save Settings" : "Create Tiebreak Set" %>"
			>
			</form>
		</div>


%		if ($protocol) {

			<h4 class="martopmore">Tiebreaks in order</h4>


<%perl>

			my $prime;

	   		foreach my $tiebreak (
				sort {$a->priority <=> $b->priority}
					Tab::Tiebreak->search(protocol => $protocol->id)
			) {

				$prime = $tiebreak->priority if $tiebreak->priority > $prime;

				my $highlow;

				my $highlow_count = $tiebreak->highlow_count;
				my $highlow_threshold = $tiebreak->highlow_threshold;
				my $highlow_target = $tiebreak->highlow_target;

				$highlow_count = 1 unless $highlow_count;

				if ($highlow_target) {

					if ($tiebreak->highlow == 1) {
						$highlow = ", dropping the best &amp; worst ";
					} elsif ($tiebreak->highlow == 3) {
						$highlow = ", dropping the best ";
					} elsif ($tiebreak->highlow == 4) {
						$highlow = ", dropping the worst";
					}

					$highlow .= " until there are $highlow_target scores";

				} else {
					if ($tiebreak->highlow == 1) {
						$highlow = ", except the ".$highlow_count." best &amp; worst";
					} elsif ($tiebreak->highlow == 3) {
						$highlow = ", except the ".$highlow_count." best";
					} elsif ($tiebreak->highlow == 4) {
						$highlow = ", except the ".$highlow_count." worst";
					} elsif ($tiebreak->highlow == 5) {
						$highlow = ", including only the ".$highlow_count." best";
					}
				}

				my $name = $tiebreak->name;

				$name =~ s/diff/differential/g;
				$name =~ s/judgepref/Judges Preference on Ranks (if tied)/g;
				$name =~ s/headtohead/Head to Head wins (if tied)/g;
				$name =~ s/opp/Opponents' avg/g;
				$name =~ s/judgevar2/JVar based on Population - Z2/g;
				$name =~ s/judgevar/Judge Variance Points - Z/g;

				if ($name eq "seed") {
					$name = "Prelim Seed";
				} elsif ($name eq "3way_pts_worst") {
					$name = "Break three-way tie; remove worst points ";
				} elsif ($name eq "entry_vote_one") {
					$name = "Entry vote (count as one)";
				} elsif ($name eq "entry_vote_all") {
					$name = "Entry vote (count all)";
				} elsif ($name eq "3way_rcp_worst") {
					$name = "Break three-way tie; remove worst recips ";
				} elsif ($name eq "three_way_recip") {
					$name = "Break three-way tie; remove best recips ";
				} elsif ($name eq "three_way_point") {
					$name = "Break three-way tie; remove best points ";
				} elsif ($name eq "best_po") {
					$name = "Best Presiding Officer on Parliamentarian ballot";
				} else {
					$name =~ s/_/ /g;
					$name = ucfirst($name);
				}

				if ($tiebreak->result eq "win") {
					$name .= " in wins";
				} elsif ($tiebreak->result eq "loss") {
					$name .= " in losses";
				} elsif ($tiebreak->result eq "split") {
					$name .= " in splits";
				}

</%perl>
				<div class="pagefull row ltborder">

					<span class="threequarters">
						 <% $tiebreak->priority %>.
%						if ($name eq "Rounds") {
							Last round competed in
%						} elsif ($name eq "NSDA Points") {
							<% $name %>
%						} elsif ($name eq "Prelim Seed") {
							<% $name %>
%						} else {
%						    if ($name eq "Reciprocals") {
								Reciprocal ranks (# of 1s, # of 2s)
%							} else {
								<% $name %>
%							}
%							if ($tiebreak->count eq 'specific') {
								 from Round #<% $tiebreak->count_round %>
%							} else {
								 from <% $tiebreak->count %> round(s)
%							}
<%perl>
							if ($tiebreak->truncate && $tiebreak->truncate_smallest) {

								$m->print(", truncate to ".$tiebreak->truncate." or smallest");

							} elsif ($tiebreak->truncate) {

   								$m->print(", truncate to ".$tiebreak->truncate);

							} elsif ($tiebreak->truncate_smallest) {

   								$m->print(", truncate to smallest section");
							}

							if ($tiebreak->chair eq "nonchair") {
								$m->print(", scorers only ");
							}
							if ($tiebreak->chair eq "chair") {
								$m->print(", chair/parli only ");
							}
</%perl>
							<%
								$highlow
							%> <%
								($tiebreak->multiplier > 1)
							 		? ", multiplied by ".$tiebreak->multiplier
									: ""
							%> <%
								$tiebreak->child > 0
								 	? ", composite on ".$tiebreak->child->name
									: ""
							%> <%
								$tiebreak->violation > 0
									? ", +".$tiebreak->violation." for violation"
									: ""
							%>
%						}
					</span>

					<span class="eighth rightalign">
            	    	<a
							class="bluetext button hover buttonwhite fa fa-sm fa-edit"
							onClick="$('.<% $tiebreak->id %>').toggleClass('hidden'); fixVisual();"
						></a>
					</span>

					<span class="eighth rightalign">
            	    	<a
							class="redtext button hover buttonwhite fa fa-sm fa-trash"
							href="tiebreak_rm.mhtml?tiebreak_id=<% $tiebreak->id %>"
						></a>
					</span>

				</div>

				<div class="centeralign ltborder pagefull hidden <% $tiebreak->id %>">

					<h5 class="leftalign">Edit tiebreak <% $tiebreak->name %>:</h5>

					<& "tiebreak_edit.mas",
						tiebreak     => $tiebreak,
						protocol => $protocol
					&>
				</div>

%			}

%			$prime++;

			<div class="martopmore pagefull">

				<h5 class="martopmore">Add new tiebreaker:</h5>

				<& "tiebreak_edit.mas",
					protocol => $protocol,
					prime        => $prime
				&>
			</div>

%		}
	</div>

	<div class="menu">
<%perl>
		my @sets =
			sort {$a->name cmp $b->name}
			Tab::Protocol->search(tourn => $tourn->id);
</%perl>

		<div class="sidenote">

%			if ($tourn_settings->{"nsda_district"}) {
%				my $warn = "You are about to shift all your tiebreaker sets.  Are you sure?";
				<h4>Districts Reset</h4>
				<a
					class = "yellow full"
					href  = "refresh_districts.mhtml"
					<& "/funclib/confirm.mas", warn => $warn &>
				>
					Reset Districts Tiebreakers to Defaults
				</a>
%			}

			<h4>Tiebreak sets</h4>
				<a
					class = "yellow full marbottom"
					href  = "tiebreaks.mhtml"
				>
					Add a new set
				</a>

%				foreach my $protocol (@sets) {
					<a
						class = "<% $protocol_id == $protocol->id ? "dk" : "" %>blue full"
						href  = "tiebreaks.mhtml?protocol_id=<% $protocol->id %>"
					>
						<% $protocol->name %>
					</a>
%				}

			<br />

			<h4 class="martop">Explain, Please</h4>

			<p>
				Create a tiebreak set for each type of advancement you wish to
				have; for example, one set for Debate Prelims, one for Debate
				Elims, one for IE Prelims, one for IE Elims, and one for Debate
				Top Speakers.
			</p>

			<a
				href  = "tiebreaks_explain.mhtml"
				class = "yellow full"
			>
				Guide to Tiebreakers
			</a>
		</div>
	</div>
