#!/usr/bin/perl -w

my @prod_servers = ("tabroom-www1", "tabroom-www2");
my $now = `/bin/date`;

foreach my $server (@prod_servers) {
	print "\n\nDEPLOYING MASON TO ".$server." at $now \n\n";

	my $result = `ssh tabroom\@$server \"cd /www/tabroom; git pull" `;
	chomp $result;
	print $result;
	print "\n\n";

	print "\n\nDEPLOYING INDEXCARDS TO ".$server." at $now \n\n";
	$result = `ssh tabroom\@$server \"cd /www/indexcards; git pull" `;
	chomp $result;

	if ($result eq "Already up to date.") {
		print "No new code found. $server update done.\n";
	} else {
		print $result;
		print "New API code found.  Updating NPM and restarting on $server...\n";
		system "ssh tabroom\@$server \"cd /www/indexcards; npm install\" ";
		system "ssh tabroom\@$server \"sudo systemctl restart indexcards\" ";
	}
}

